<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NIGHTREIGN ボス＆キャラ 抽選ツール</title>

  <!-- CSS分離版 -->
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/components.css" />
  <link rel="stylesheet" href="./css/iphone-portrait.css" />
</head>

<body>
<header>
  <h1>ELDEN RING NIGHTREIGN：ボス＆キャラ 抽選ツール</h1>
  <div class="sub">
    ・表示は常に <b>1行</b>： <b>ボス → キャラ①〜③</b>（画面が狭い場合は横スクロール）<br/>
    ・フィルタ（通常/常夜/深き夜・DLC）は「キャラ重複可」等と同じ領域に統合<br/>
    ・キャラ枠色：<b>キャラ1＝赤</b>、<b>キャラ2＝青</b>、<b>キャラ3＝緑</b>
  </div>
</header>

<main>
  <section class="panel">
    <h2>抽選設定</h2>

    <div class="controls">
      <label>出撃キャラ数
        <input id="playerCount" type="number" min="1" max="3" value="3">
      </label>

      <label>抽選回数（まとめて）
        <input id="rollCount" type="number" min="1" max="50" value="1">
      </label>

      <label>
        <input id="allowDup" type="checkbox" checked>
        キャラ重複可
      </label>

      <label>表示モード
        <select id="viewMode">
          <option value="latest">最新のみ</option>
          <option value="stack">履歴を積む</option>
        </select>
      </label>

      <label class="filterTag stage-normal" style="--stage:#7aa2ff;">
        <span class="dot"></span>
        <input type="checkbox" id="fNormal" checked> 通常
      </label>

      <label class="filterTag stage-everdark" style="--stage:#b07aff;">
        <span class="dot"></span>
        <input type="checkbox" id="fEverdark" checked> 常夜
      </label>

      <label class="filterTag stage-deep" style="--stage:#7dffb2;">
        <span class="dot"></span>
        <input type="checkbox" id="fDeep" checked> 深き夜
      </label>

      <label class="filterTag" style="--stage:#ffcc66;">
        <span class="dot" style="background:#ffcc66;"></span>
        <input type="checkbox" id="fDLC" checked> DLCを含める（ボス/キャラ）
      </label>

      <button id="startBtn">抽選開始</button>
      <button id="clearBtn" class="secondary">クリア</button>
    </div>

    <div class="hint">
      常夜は日替わり枠のため「常夜①〜③」表記とする。画像は <b>images/chars/</b> と <b>images/stages/</b> 配下に配置する。
    </div>

    <div id="warnBox" class="warn"></div>

    <h2 style="margin-top:18px;">抽選結果（履歴）</h2>
    <div id="history" style="margin-top:10px; display:grid; gap:12px;"></div>
  </section>
</main>

<script>
  // ===== キャラ定義（key/ファイル名は英名、表示は和名） =====
  const CHARACTERS = [
    { key:"wylder",     name:"追跡者", img:"images/chars/wylder.png",     dlc:false },
    { key:"guardian",   name:"守護者", img:"images/chars/guardian.png",   dlc:false },
    { key:"ironeye",    name:"鉄の目", img:"images/chars/ironeye.png",    dlc:false },
    { key:"duchess",    name:"レディ", img:"images/chars/duchess.png",    dlc:false },
    { key:"raider",     name:"無頼漢", img:"images/chars/raider.png",     dlc:false },
    { key:"revenant",   name:"復讐者", img:"images/chars/revenant.png",   dlc:false },
    { key:"recluse",    name:"隠者",   img:"images/chars/recluse.png",    dlc:false },
    { key:"executor",   name:"執行者", img:"images/chars/executor.png",   dlc:false },
    // DLC
    { key:"scholar",    name:"学者",   img:"images/chars/scholar.png",    dlc:true  },
    { key:"undertaker", name:"葬儀屋", img:"images/chars/undertaker.png", dlc:true  }
  ];

  // ===== ボス/ステージ定義 =====
  const STAGES = [
    // 通常（本編）
    { name:"三つ首の獣",       type:"通常",   dlc:false, img:"images/stages/gladius.jpg" },
    { name:"喰らいつく顎",     type:"通常",   dlc:false, img:"images/stages/adel.jpg" },
    { name:"知性の蟲",         type:"通常",   dlc:false, img:"images/stages/gnoster.jpg" },
    { name:"兆し",             type:"通常",   dlc:false, img:"images/stages/maris.jpg" },
    { name:"調律の魔物",       type:"通常",   dlc:false, img:"images/stages/libra.jpg" },
    { name:"闇駆ける狩人",     type:"通常",   dlc:false, img:"images/stages/fulghor.jpg" },
    { name:"霧の裂け目",       type:"通常",   dlc:false, img:"images/stages/caligo.jpg" },
    { name:"夜を象る者",       type:"通常",   dlc:false, img:"images/stages/nameless.jpg" },

    // 通常（DLC）
    { name:"安寧者たち", type:"通常", dlc:true, img:"images/stages/harmonia.jpg" },
    { name:"瓦礫の王",   type:"通常", dlc:true, img:"images/stages/straghess.jpg" },

    // 常夜（日替わり枠：①〜③）
    { name:"常夜①", type:"常夜", dlc:false, img:"images/stages/everdark_01.jpg" },
    { name:"常夜②", type:"常夜", dlc:false, img:"images/stages/everdark_02.jpg" },
    { name:"常夜③", type:"常夜", dlc:false, img:"images/stages/everdark_03.jpg" },

    // 深き夜（モード枠）
    { name:"深き夜", type:"深き夜", dlc:false, img:"images/stages/deep.jpg" }
  ];

  // ===== Elements =====
  const playerCountEl = document.getElementById("playerCount");
  const rollCountEl = document.getElementById("rollCount");
  const allowDupEl = document.getElementById("allowDup");
  const viewModeEl = document.getElementById("viewMode");
  const startBtn = document.getElementById("startBtn");
  const clearBtn = document.getElementById("clearBtn");
  const historyEl = document.getElementById("history");
  const warnBox = document.getElementById("warnBox");

  const fNormal = document.getElementById("fNormal");
  const fEverdark = document.getElementById("fEverdark");
  const fDeep = document.getElementById("fDeep");
  const fDLC = document.getElementById("fDLC");

  // ===== Utils =====
  const randInt = (n) => Math.floor(Math.random() * n);

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[s]));
  }

  function showWarn(msg){
    warnBox.style.display = "block";
    warnBox.textContent = msg;
  }
  function hideWarn(){
    warnBox.style.display = "none";
    warnBox.textContent = "";
  }

  function stageClass(type){
    if (type === "通常") return "stage-normal";
    if (type === "常夜") return "stage-everdark";
    return "stage-deep";
  }

  function enabledStageTypes(){
    const t = [];
    if (fNormal.checked) t.push("通常");
    if (fEverdark.checked) t.push("常夜");
    if (fDeep.checked) t.push("深き夜");
    return t;
  }

  function allowDLCAll(){
    return !!fDLC.checked;
  }

  function characterPool(){
    const allow = allowDLCAll();
    return CHARACTERS.filter(c => allow || !c.dlc);
  }

  function stagePool(){
    const enabled = enabledStageTypes();
    const allow = allowDLCAll();
    return STAGES.filter(s => enabled.includes(s.type) && (allow || !s.dlc));
  }

  function pickStageFiltered(){
    const pool = stagePool();
    if (pool.length === 0) throw new Error("抽選対象のボス/ステージがありません。type選択 or DLCトグルをご確認ください。");
    return pool[randInt(pool.length)];
  }

  function pickCharacters(nPlayers, allowDup=true){
    const poolBase = characterPool();
    if (poolBase.length === 0) throw new Error("抽選対象のキャラがありません。DLCトグルをご確認ください。");
    if (!allowDup && nPlayers > poolBase.length) throw new Error("重複不可の場合、出撃キャラ数が抽選対象キャラ数を超えています。");

    const picks = [];
    if (allowDup){
      for (let i=0;i<nPlayers;i++) picks.push(poolBase[randInt(poolBase.length)]);
    } else {
      const pool = structuredClone(poolBase);
      for (let i=0;i<nPlayers;i++) picks.push(pool.splice(randInt(pool.length), 1)[0]);
    }
    return picks;
  }

  function charFrameClass(idx){
    if (idx === 1) return "char1";
    if (idx === 2) return "char2";
    if (idx === 3) return "char3";
    return "";
  }

  function buildCard({title, pill, imgSrc, imgAlt, fallbackHtml, extraClass=""}){
    const card = document.createElement("div");
    card.className = `card ${extraClass}`.trim();

    const head = document.createElement("div");
    head.className = "cardHead";
    head.innerHTML = `<span class="name">${title}</span><span class="pill">${pill}</span>`;

    const imgWrap = document.createElement("div");
    imgWrap.className = "imgWrap";

    const img = document.createElement("img");
    img.alt = imgAlt;
    img.src = imgSrc;
    img.loading = "lazy";
    img.referrerPolicy = "no-referrer";

    img.onerror = () => {
      imgWrap.innerHTML = `<div style="padding:0 14px; color:var(--muted); font-size:12px; line-height:1.5;">` +
        `画像が見つかりませんでした。<br/><b>${escapeHtml(imgSrc)}</b>` +
        `</div>`;
    };

    imgWrap.appendChild(img);

    const fb = document.createElement("div");
    fb.className = "fallback";
    fb.innerHTML = fallbackHtml;

    card.appendChild(head);
    card.appendChild(imgWrap);
    card.appendChild(fb);
    return card;
  }

  function createBossCard(stageObj){
    return buildCard({
      title: `ボス：${escapeHtml(stageObj.name)}`,
      pill: `${escapeHtml(stageObj.type)}${stageObj.dlc ? " / DLC" : ""}`,
      imgSrc: stageObj.img,
      imgAlt: stageObj.name,
      fallbackHtml:
        `image: <span style="color:#dbe3ff;">${escapeHtml(stageObj.img)}</span><br/>` +
        `type: <b>${escapeHtml(stageObj.type)}</b> / DLC: <b style="color:${stageObj.dlc ? "#ffcc66" : "#a8b0c2"};">${stageObj.dlc ? "ON" : "OFF"}</b>`,
      extraClass: `bossCard ${stageClass(stageObj.type)}`
    });
  }

  function createCharCard(c, idx){
    return buildCard({
      title: `キャラ${idx}：${escapeHtml(c.name)}`,
      pill: `CHAR${c.dlc ? " / DLC" : ""}`,
      imgSrc: c.img,
      imgAlt: c.name,
      fallbackHtml:
        `image: <span style="color:#dbe3ff;">${escapeHtml(c.img)}</span>` +
        (c.dlc ? ` <span style="color:#ffcc66; font-weight:900;">/ DLC</span>` : ``),
      extraClass: charFrameClass(idx)
    });
  }

  function createResultBlock(picks, stageObj, rollIndex){
    const block = document.createElement("div");
    block.className = "block";

    const head = document.createElement("div");
    head.className = "blockHead";

    const left = document.createElement("div");
    left.innerHTML = `<b>抽選 #${rollIndex}</b> <span style="color:var(--muted); font-size:12px;">（${picks.length}人）</span>`;

    const right = document.createElement("div");
    right.className = "meta";
    right.innerHTML = `BOSS: <b>${escapeHtml(stageObj.name)}</b> (${escapeHtml(stageObj.type)})` +
      (stageObj.dlc ? ` <span style="color:#ffcc66; font-weight:900;">DLC</span>` : ``);

    head.appendChild(left);
    head.appendChild(right);
    block.appendChild(head);

    const row = document.createElement("div");
    row.className = "resultRow";
    row.appendChild(createBossCard(stageObj));
    picks.forEach((c, i) => row.appendChild(createCharCard(c, i+1)));
    block.appendChild(row);

    return block;
  }

  function updateStartBtnState(){
    try {
      const nPlayers = Math.max(1, Math.min(3, Number(playerCountEl.value || 3)));
      playerCountEl.value = String(nPlayers);

      if (enabledStageTypes().length === 0) {
        startBtn.disabled = true;
        showWarn("ステージtypeが未選択です。少なくとも1つ選択してください。");
        return;
      }
      if (stagePool().length === 0) {
        startBtn.disabled = true;
        showWarn("抽選対象のボス/ステージがありません。type選択 or DLCトグルをご確認ください。");
        return;
      }
      if (characterPool().length === 0) {
        startBtn.disabled = true;
        showWarn("抽選対象のキャラがありません。DLCトグルをご確認ください。");
        return;
      }
      if (!allowDupEl.checked && nPlayers > characterPool().length) {
        startBtn.disabled = true;
        showWarn("重複不可の場合、出撃キャラ数が抽選対象キャラ数を超えています。");
        return;
      }

      startBtn.disabled = false;
      hideWarn();
    } catch (e) {
      startBtn.disabled = true;
      showWarn(e.message);
    }
  }

  function doStart(){
    try {
      updateStartBtnState();
      if (startBtn.disabled) return;

      const nPlayers = Math.max(1, Math.min(3, Number(playerCountEl.value || 3)));
      const nRolls = Math.max(1, Math.min(50, Number(rollCountEl.value || 1)));
      const allowDup = !!allowDupEl.checked;
      const mode = viewModeEl.value;

      if (mode === "latest") historyEl.innerHTML = "";

      for (let r=1; r<=nRolls; r++) {
        const stageObj = pickStageFiltered();
        const picks = pickCharacters(nPlayers, allowDup);
        historyEl.appendChild(createResultBlock(picks, stageObj, r));
      }

    } catch (e) {
      showWarn(e.message);
    }
  }

  function clearAll(){
    historyEl.innerHTML = "";
    hideWarn();
  }

  startBtn.addEventListener("click", doStart);
  clearBtn.addEventListener("click", clearAll);

  [playerCountEl, rollCountEl, allowDupEl, viewModeEl, fNormal, fEverdark, fDeep, fDLC]
    .forEach(el => el.addEventListener("change", updateStartBtnState));

  updateStartBtnState();
</script>
</body>
</html>
