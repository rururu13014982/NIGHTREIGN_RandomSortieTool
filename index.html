<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NIGHTREIGN ボス＆キャラ 抽選ツール</title>
  <style>
    :root{
      --bg:#0b0e14; --panel:#111828; --panel2:#0f1522; --text:#e7eaf0;
      --muted:#a8b0c2; --accent:#7aa2ff; --accent2:#7dffb2;
      --border:#26314a; --stage:#7aa2ff;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, #151c2e 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{ padding:20px 16px 10px; max-width:1100px; margin:0 auto; }
    h1{ margin:0; font-size:20px; letter-spacing:.02em; }
    .sub{ color:var(--muted); font-size:13px; margin-top:6px; line-height:1.45; }

    main{ max-width:1100px; margin:0 auto; padding:12px 16px 28px; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border:1px solid var(--border);
      border-radius:14px; padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .panel h2{ margin:0 0 10px; font-size:15px; color:#dbe3ff; }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .controls label{
      display:flex; align-items:center; gap:8px;
      background:var(--panel2); border:1px solid var(--border);
      padding:10px 10px; border-radius:12px; color:var(--text); font-size:13px;
    }
    input[type="number"], select{
      background:#0b1220; color:var(--text);
      border:1px solid var(--border); border-radius:10px;
      padding:8px 10px; font-size:13px; outline:none;
      width: 110px;
    }
    select{ width:auto; }

    button{
      cursor:pointer; border:none; border-radius:12px;
      padding:10px 14px;
      color:#07101f; font-weight:900;
      background: linear-gradient(90deg, var(--accent), #9b7aff);
      box-shadow: 0 10px 20px rgba(122,162,255,.18);
    }
    button.secondary{
      background: linear-gradient(90deg, #2a334a, #1b2337);
      color:var(--text); border:1px solid var(--border);
      box-shadow:none;
    }
    button:disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.6); }

    .hint{ color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45; }

    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,107,107,.45);
      background: rgba(255,107,107,.08);
      color:#ffd4d4;
      font-size:12px;
      display:none;
      line-height:1.45;
    }

    /* 1行表示（ボス→キャラ①〜） */
    .resultRow{
      display:flex;
      gap:12px;
      flex-wrap:nowrap;          /* ★1行固定 */
      overflow-x:auto;           /* 画面が狭い場合は横スクロール */
      padding-bottom:6px;
      scroll-snap-type: x mandatory;
    }
    .resultRow::-webkit-scrollbar{ height:10px; }
    .resultRow::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius:999px; }

    .card{
      flex: 0 0 240px;           /* カード幅固定（1行の見た目を維持） */
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      scroll-snap-align: start;
      box-sizing: border-box;
      position: relative;
    }

    /* ★キャラ枠色（outlineでレイアウト崩れを防止） */
    .char1{ outline: 2px solid #ff4d4d; outline-offset: -2px; }
    .char2{ outline: 2px solid #4da3ff; outline-offset: -2px; }
    .char3{ outline: 2px solid #44d07a; outline-offset: -2px; }
    /* うっすら光らせたい場合（任意） */
    .char1{ box-shadow: 0 0 0 1px rgba(255,77,77,.15), 0 10px 26px rgba(0,0,0,.22); }
    .char2{ box-shadow: 0 0 0 1px rgba(77,163,255,.15), 0 10px 26px rgba(0,0,0,.22); }
    .char3{ box-shadow: 0 0 0 1px rgba(68,208,122,.15), 0 10px 26px rgba(0,0,0,.22); }

    .cardHead{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(38,49,74,.7);
      gap:10px;
    }
    .name{ font-weight:900; }
    .pill{
      font-size:11px; color:#0a1a14; font-weight:900;
      background: linear-gradient(90deg, var(--accent2), #b1ffda);
      padding:5px 8px; border-radius:999px;
      white-space:nowrap;
    }

    .imgWrap{
      display:flex; justify-content:center; align-items:center;
      height:160px;
      background: radial-gradient(360px 180px at 50% 20%, rgba(122,162,255,.25), rgba(0,0,0,0));
    }
    img{
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      filter: drop-shadow(0 14px 18px rgba(0,0,0,.45));
    }

    .fallback{
      color:var(--muted);
      font-size:12px;
      padding:10px 12px;
      line-height:1.45;
      border-top:1px solid rgba(38,49,74,.6);
      word-break: break-all;
    }

    /* ボスカードはtype色で強調 */
    .bossCard{ border-color: color-mix(in srgb, var(--stage) 45%, var(--border)); }
    .bossCard .pill{
      background: linear-gradient(90deg, color-mix(in srgb, var(--stage) 80%, white), var(--stage));
      color:#07101f;
    }
    .bossCard .imgWrap{
      background: radial-gradient(380px 190px at 50% 20%, color-mix(in srgb, var(--stage) 30%, transparent), rgba(0,0,0,0));
    }

    /* ステージtype別カラー */
    .stage-normal   { --stage:#7aa2ff; }  /* 通常: 青 */
    .stage-everdark { --stage:#b07aff; }  /* 常夜: 紫 */
    .stage-deep     { --stage:#7dffb2; }  /* 深き夜: 緑 */

    /* フィルタUI */
    .filterTag{
      display:flex; align-items:center; gap:8px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--panel2);
      font-size:13px;
    }
    .dot{
      width:10px; height:10px; border-radius:99px; display:inline-block;
      background: var(--stage);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05) inset;
    }

    .block{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.12);
    }
    .blockHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .blockHead .meta{
      color:var(--muted);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
<header>
  <h1>ELDEN RING NIGHTREIGN：ボス＆キャラ 抽選ツール</h1>
  <div class="sub">
    ・表示は常に <b>1行</b>： <b>ボス → キャラ①〜③</b>（画面が狭い場合は横スクロール）<br/>
    ・キャラ枠色：<b>キャラ1＝赤</b>、<b>キャラ2＝青</b>、<b>キャラ3＝緑</b>
  </div>
</header>

<main>
  <section class="panel">
    <h2>抽選設定</h2>

    <div class="controls">
      <label>プレイヤー数
        <input id="playerCount" type="number" min="1" max="3" value="3">
      </label>

      <label>抽選回数（まとめて）
        <input id="rollCount" type="number" min="1" max="50" value="1">
      </label>

      <label>
        <input id="allowDup" type="checkbox" checked>
        キャラ重複可
      </label>

      <label>表示モード
        <select id="viewMode">
          <option value="latest">最新のみ</option>
          <option value="stack">履歴を積む</option>
        </select>
      </label>

      <!-- ステージtypeフィルタ -->
      <label class="filterTag stage-normal" style="--stage:#7aa2ff;">
        <span class="dot"></span>
        <input type="checkbox" id="fNormal" checked> 通常
      </label>

      <label class="filterTag stage-everdark" style="--stage:#b07aff;">
        <span class="dot"></span>
        <input type="checkbox" id="fEverdark" checked> 常夜
      </label>

      <label class="filterTag stage-deep" style="--stage:#7dffb2;">
        <span class="dot"></span>
        <input type="checkbox" id="fDeep" checked> 深き夜
      </label>

      <!-- DLC単一トグル（ボス/キャラ共通） -->
      <label class="filterTag" style="--stage:#ffcc66;">
        <span class="dot" style="background:#ffcc66;"></span>
        <input type="checkbox" id="fDLC" checked> DLCを含める（ボス/キャラ）
      </label>

      <!-- 抽選ボタンはこれ1つのみ -->
      <button id="startBtn">抽選開始</button>
      <button id="clearBtn" class="secondary">クリア</button>
    </div>

    <div class="hint">
      常夜は日替わり枠のため「常夜①〜③」表記です。画像は <b>images/chars/</b> と <b>images/stages/</b> 配下に配置してください。
    </div>

    <div id="warnBox" class="warn"></div>

    <h2 style="margin-top:18px;">抽選結果（履歴）</h2>
    <div id="history" style="margin-top:10px; display:grid; gap:12px;"></div>
  </section>
</main>

<script>
  // ===== キャラ定義（key/ファイル名は英名、表示は和名）=====
  const CHARACTERS = [
    { key:"wylder",     name:"追跡者", img:"images/chars/wylder.png",     dlc:false },
    { key:"guardian",   name:"守護者", img:"images/chars/guardian.png",   dlc:false },
    { key:"ironeye",    name:"鉄の目", img:"images/chars/ironeye.png",    dlc:false },
    { key:"duchess",    name:"レディ", img:"images/chars/duchess.png",    dlc:false },
    { key:"raider",     name:"無頼漢", img:"images/chars/raider.png",     dlc:false },
    { key:"revenant",   name:"復讐者", img:"images/chars/revenant.png",   dlc:false },
    { key:"recluse",    name:"隠者",   img:"images/chars/recluse.png",    dlc:false },
    { key:"executor",   name:"執行者", img:"images/chars/executor.png",   dlc:false },

    // DLCキャラ
    { key:"scholar",    name:"学者",   img:"images/chars/scholar.png",    dlc:true  },
    { key:"undertaker", name:"葬儀屋", img:"images/chars/undertaker.png", dlc:true  }
  ];

  // ===== ボス/ステージ定義 =====
  const STAGES = [
    // 通常（本編）
    { name:"三つ首の獣",       type:"通常",   dlc:false, img:"images/stages/gladius.jpg" },
    { name:"喰らいつく顎",     type:"通常",   dlc:false, img:"images/stages/adel.jpg" },
    { name:"知性の蟲",         type:"通常",   dlc:false, img:"images/stages/gnoster.jpg" },
    { name:"兆し",             type:"通常",   dlc:false, img:"images/stages/maris.jpg" },
    { name:"調律の魔物",       type:"通常",   dlc:false, img:"images/stages/libra.jpg" },
    { name:"闇駆ける狩人",     type:"通常",   dlc:false, img:"images/stages/fulghor.jpg" },
    { name:"霧の裂け目",       type:"通常",   dlc:false, img:"images/stages/caligo.jpg" },
    { name:"夜を象る者",       type:"通常",   dlc:false, img:"images/stages/nameless.jpg" },

    // 通常（DLC）
    { name:"安寧者たち", type:"通常", dlc:true, img:"images/stages/harmonia.jpg" },
    { name:"瓦礫の王",   type:"通常", dlc:true, img:"images/stages/straghess.jpg" },

    // 常夜（日替わり枠：①〜③）
    { name:"常夜①", type:"常夜", dlc:false, img:"images/stages/everdark_01.jpg" },
    { name:"常夜②", type:"常夜", dlc:false, img:"images/stages/everdark_02.jpg" },
    { name:"常夜③", type:"常夜", dlc:false, img:"images/stages/everdark_03.jpg" },

    // 深き夜（モード枠）
    { name:"深き夜", type:"深き夜", dlc:false, img:"images/stages/deep.jpg" }
  ];

  // ===== Elements =====
  const playerCountEl = document.getElementById("playerCount");
  const rollCountEl = document.getElementById("rollCount");
  const allowDupEl = document.getElementById("allowDup");
  const viewModeEl = document.getElementById("viewMode");
  const startBtn = document.getElementById("startBtn");
  const clearBtn = document.getElementById("clearBtn");
  const historyEl = document.getElementById("history");
  const warnBox = document.getElementById("warnBox");

  const fNormal = document.getElementById("fNormal");
  const fEverdark = document.getElementById("fEverdark");
  const fDeep = document.getElementById("fDeep");
  const fDLC = document.getElementById("fDLC");

  // ===== Utils =====
  const randInt = (n) => Math.floor(Math.random() * n);

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[s]));
  }

  function showWarn(msg){
    warnBox.style.display = "block";
    warnBox.textContent = msg;
  }
  function hideWarn(){
    warnBox.style.display = "none";
    warnBox.textContent = "";
  }

  function stageClass(type){
    if (type === "通常") return "stage-normal";
    if (type === "常夜") return "stage-everdark";
    return "stage-deep";
  }

  function enabledStageTypes(){
    const t = [];
    if (fNormal.checked) t.push("通常");
    if (fEverdark.checked) t.push("常夜");
    if (fDeep.checked) t.push("深き夜");
    return t;
  }

  function allowDLCAll(){ return !!fDLC.checked; }

  function characterPool(){
    const allow = allowDLCAll();
    return CHARACTERS.filter(c => allow || !c.dlc);
  }

  function stagePool(){
    const enabled = enabledStageTypes();
    const allow = allowDLCAll();
    return STAGES.filter(s => enabled.includes(s.type) && (allow || !s.dlc));
  }

  function pickStageFiltered(){
    const pool = stagePool();
    if (pool.length === 0) throw new Error("抽選対象のボス/ステージがありません。type選択 or DLCトグルをご確認ください。");
    return pool[randInt(pool.length)];
  }

  function pickCharacters(nPlayers, allowDup=true){
    const poolBase = characterPool();
    if (poolBase.length === 0) throw new Error("抽選対象のキャラがありません。DLCトグルをご確認ください。");
    if (!allowDup && nPlayers > poolBase.length) throw new Error("重複不可の場合、プレイヤー数が抽選対象キャラ数を超えています。");

    const picks = [];
    if (allowDup){
      for (let i=0;i<nPlayers;i++){
        picks.push(poolBase[randInt(poolBase.length)]);
      }
    }else{
      const pool = structuredClone(poolBase);
      for (let i=0;i<nPlayers;i++){
        const idx = randInt(pool.length);
        picks.push(pool.splice(idx,1)[0]);
      }
    }
    return picks;
  }

  // ===== Card Builders =====
  function buildCard({title, pill, imgSrc, imgAlt, fallbackHtml, extraClass=""}){
    const card = document.createElement("div");
    card.className = `card ${extraClass}`.trim();

    const head = document.createElement("div");
    head.className = "cardHead";
    head.innerHTML = `<span class="name">${title}</span><span class="pill">${pill}</span>`;

    const imgWrap = document.createElement("div");
    imgWrap.className = "imgWrap";

    const img = document.createElement("img");
    img.alt = imgAlt;
    img.src = imgSrc;
    img.loading = "lazy";
    img.referrerPolicy = "no-referrer";

    img.onerror = () => {
      imgWrap.innerHTML = `<div style="padding:0 14px; color:var(--muted); font-size:12px; line-height:1.5;">
        画像が見つかりませんでした。<br/>
        <b>${escapeHtml(imgSrc)}</b>
      </div>`;
    };

    imgWrap.appendChild(img);

    const fb = document.createElement("div");
    fb.className = "fallback";
    fb.innerHTML = fallbackHtml;

    card.appendChild(head);
    card.appendChild(imgWrap);
    card.appendChild(fb);
    return card;
  }

  function createBossCard(stageObj){
    return buildCard({
      title: `ボス：${escapeHtml(stageObj.name)}`,
      pill: `${escapeHtml(stageObj.type)}${stageObj.dlc ? " / DLC" : ""}`,
      imgSrc: stageObj.img,
      imgAlt: stageObj.name,
      fallbackHtml:
        `image: <span style="color:#dbe3ff;">${escapeHtml(stageObj.img)}</span><br/>` +
        `type: <b>${escapeHtml(stageObj.type)}</b> / DLC: <b style="color:${stageObj.dlc ? "#ffcc66" : "#a8b0c2"};">${stageObj.dlc ? "ON" : "OFF"}</b>`,
      extraClass: `bossCard ${stageClass(stageObj.type)}`
    });
  }

  function charFrameClass(idx){
    if (idx === 1) return "char1";
    if (idx === 2) return "char2";
    if (idx === 3) return "char3";
    return "";
  }

  function createCharCard(c, idx){
    const frame = charFrameClass(idx);
    return buildCard({
      title: `キャラ${idx}：${escapeHtml(c.name)}`,
      pill: `CHAR${c.dlc ? " / DLC" : ""}`,
      imgSrc: c.img,
      imgAlt: c.name,
      fallbackHtml:
        `image: <span style="color:#dbe3ff;">${escapeHtml(c.img)}</span>` +
        (c.dlc ? ` <span style="color:#ffcc66; font-weight:900;">/ DLC</span>` : ``),
      extraClass: frame
    });
  }

  function createResultBlock(picks, stageObj, rollIndex){
    const block = document.createElement("div");
    block.className = "block";

    const head = document.createElement("div");
    head.className = "blockHead";

    const left = document.createElement("div");
    left.innerHTML = `<b>抽選 #${rollIndex}</b> <span style="color:var(--muted); font-size:12px;">（${picks.length}人）</span>`;

    const right = document.createElement("div");
    right.className = "meta";
    right.innerHTML = `BOSS: <b>${escapeHtml(stageObj.name)}</b> (${escapeHtml(stageObj.type)})` +
                      (stageObj.dlc ? ` <span style="color:#ffcc66; font-weight:900;">DLC</span>` : ``);

    head.appendChild(left);
    head.appendChild(right);
    block.appendChild(head);

    // 1行：ボス → キャラ①〜
    const row = document.createElement("div");
    row.className = "resultRow";
    row.appendChild(createBossCard(stageObj));
    picks.forEach((c, i) => row.appendChild(createCharCard(c, i+1)));
    block.appendChild(row);

    return block;
  }

  // ===== State =====
  function updateStartBtnState(){
    try{
      const enabledTypes = enabledStageTypes().length;
      if (enabledTypes === 0) {
        startBtn.disabled = true;
        showWarn("ステージtypeが未選択です。少なくとも1つ選択してください。");
        return;
      }
      if (stagePool().length === 0) {
        startBtn.disabled = true;
        showWarn("抽選対象のボス/ステージがありません。type選択 or DLCトグルをご確認ください。");
        return;
      }
      if (characterPool().length === 0) {
        startBtn.disabled = true;
        showWarn("抽選対象のキャラがありません。DLCトグルをご確認ください。");
        return;
      }

      // 重複不可のときの制約も事前チェック
      const nPlayers = Math.max(1, Math.min(3, Number(playerCountEl.value || 3)));
      if (!allowDupEl.checked && nPlayers > characterPool().length) {
        startBtn.disabled = true;
        showWarn("重複不可の場合、プレイヤー数が抽選対象キャラ数を超えています。");
        return;
      }

      startBtn.disabled = false;
      hideWarn();
    }catch(e){
      startBtn.disabled = true;
      showWarn(e.message);
    }
  }

  function doStart(){
    try{
      updateStartBtnState();
      if (startBtn.disabled) return;

      const nPlayers = Math.max(1, Math.min(3, Number(playerCountEl.value || 3)));
      const nRolls = Math.max(1, Math.min(50, Number(rollCountEl.value || 1)));
      const allowDup = !!allowDupEl.checked;
      const mode = viewModeEl.value;

      if (mode === "latest") historyEl.innerHTML = "";

      for (let r=1; r<=nRolls; r++){
        const stageObj = pickStageFiltered();
        const picks = pickCharacters(nPlayers, allowDup);
        historyEl.appendChild(createResultBlock(picks, stageObj, r));
      }
    }catch(e){
      showWarn(e.message);
    }
  }

  function clearAll(){
    historyEl.innerHTML = "";
    hideWarn();
  }

  // ===== Events =====
  startBtn.addEventListener("click", doStart);
  clearBtn.addEventListener("click", clearAll);

  [playerCountEl, rollCountEl, allowDupEl, viewModeEl, fNormal, fEverdark, fDeep, fDLC]
    .forEach(el => el.addEventListener("change", updateStartBtnState));

  // Init
  updateStartBtnState();
</script>
</body>
</html>
